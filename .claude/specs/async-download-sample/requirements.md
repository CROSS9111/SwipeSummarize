# 要件定義書

## はじめに

この機能は、Next.js（フロントエンド）、FastAPI（バックエンド）、Azure Redis（タスクキュー/状態管理）を使用した非同期ダウンロード処理のサンプル実装を提供します。長時間実行されるダウンロードタスクを開始し、リアルタイムで進捗を追跡し、ページ遷移後も永続的な状態管理により進捗の可視性を維持する方法を実証します。

## プロダクトビジョンとの整合性

このサンプルは、Tech0学習リポジトリの「実践的でプロダクションレディなコード例を提供する」という目標に沿っています。モダンな非同期処理パターン、クラウドサービス統合（Azure Redis）、学習者が自身のプロジェクトに適用できる実世界のアプリケーションアーキテクチャを実証します。

## 要件

### 要件1: 非同期タスクの開始

**ユーザーストーリー:** ユーザーとして、Webインターフェースからダウンロードタスクを開始したい。これにより、UIをブロックせずに長時間実行される操作を開始し、ダウンロード中も他の作業を継続できる。

#### 受け入れ基準

1. ユーザーがダウンロードボタンをクリックした時、システムは一意のタスクID（UUID v4形式）を作成しRedisにタスクをエンキューすること
2. タスクがエンキューされた時、システムは500ms以内にタスクIDをフロントエンドに返すこと
3. タスクIDを受け取った時、フロントエンドは初期ステータスを「キュー中」と表示すること
4. タスク作成が失敗した場合、システムは具体的なエラーメッセージ（例：「Redisへの接続に失敗しました」）をユーザーに返すこと
5. Redis接続が失敗した時、システムは指数バックオフ（1秒、2秒、4秒）でリトライし、3回失敗後にエラーを返すこと

### 要件2: リアルタイム進捗追跡

**ユーザーストーリー:** ユーザーとして、ダウンロードタスクのリアルタイム進捗更新を見たい。これにより、残り時間を把握し、完了を待つべきか他の作業を進めるべきか判断できる。

#### 受け入れ基準

1. タスクが処理中の時、バックエンドは2%進捗するごとにRedisの進捗率を更新すること
2. フロントエンドは1.5秒ごとにAPIをポーリングし、現在のステータスと進捗を取得すること
3. APIが進捗をリクエストされた時、Redisから現在のステータス（処理中、完了、失敗）と進捗率（0-100%）を2秒以内に返すこと
4. 進捗更新が発生した時、フロントエンドはプログレスバーとパーセンテージ表示を更新すること
5. タスクが正常に完了した時、進捗は100%とステータス「完了」を表示し、ダウンロードリンクを表示すること
6. タスクが失敗した場合、システムはRedisにエラー詳細（エラータイプ、メッセージ、タイムスタンプ）を保存しユーザーにエラーメッセージを表示すること
7. ネットワーク接続が切断された時、フロントエンドはオフラインインジケーターを表示し、指数バックオフでポーリングをリトライすること

### 要件3: 永続的な進捗状態

**ユーザーストーリー:** ユーザーとして、ページ更新やナビゲーション後もタスク進捗を見たい。これにより、ダウンロードを見失うことなく、自由にサイト内を移動できる。

#### 受け入れ基準

1. ユーザーがページから離れた時、タスクはバックグラウンドで処理を継続すること
2. ユーザーがページに戻った時、システムはバックエンドAPIからユーザーに紐づくすべてのタスクを取得すること（GET /api/tasks/my-tasks）
3. ページが更新された時、システムはAPIからユーザーのタスク一覧を再取得し、UI上でタスクリストを復元すること
4. ブラウザが閉じられて再度開かれた時、システムは認証情報（APIキー）を使用してユーザーのタスクを取得すること
5. すべてのタスクはバックエンド（Redis）で管理され、user_idに紐づけられていること
6. タスク状態はRedisに最低24時間保持され、TTL（Time To Live）経過後に自動削除されること
7. 認証情報（APIキー）はlocalStorageに保存し、すべてのAPIリクエストに含めること

### 要件4: 複数の同時タスク

**ユーザーストーリー:** ユーザーとして、複数のダウンロードタスクを同時に開始したい。これにより、複数のファイルを効率的に一括ダウンロードでき、時間を節約できる。

#### 受け入れ基準

1. ユーザーが新しいタスクを開始した時、システムは最大10個の同時タスクをサポートすること
2. タスクリストを表示する時、各タスクは独立した進捗率、ステータス、作成時刻を表示すること
3. 1つのタスクが完了または失敗した時、他のタスクは影響を受けず独立して処理を継続すること
4. 10個の同時タスク制限に達した場合、システムは新しいタスクを受け付けず「同時タスク数が上限に達しました」というメッセージを表示すること
5. タスクリストは作成時刻の降順（新しい順）でソート可能であること
6. タスクリストはステータス（すべて、処理中、完了、失敗）でフィルタリング可能であること

### 要件5: タスク結果へのアクセス

**ユーザーストーリー:** ユーザーとして、完了したダウンロード結果にアクセスしたい。これにより、リクエストしたファイルを取得し、ローカルに保存できる。

#### 受け入れ基準

1. タスクが正常に完了した時、システムはダウンロードリンク（一時URL、有効期限1時間）を生成しUIに表示すること
2. ユーザーがダウンロードリンクをクリックした時、システムは生成されたファイル（サンプルではテキストファイル）を提供すること
3. ダウンロードリンクがアクセスされた時、システムはタスクの完了ステータスとファイルの存在を検証すること
4. 結果ファイルが存在しない、または有効期限切れの場合、システムは「ファイルが見つかりません」または「ダウンロードリンクの有効期限が切れました」というエラーメッセージを表示すること
5. 完了したタスクの結果ファイルは24時間後に自動的にクリーンアップされること

### 要件6: タスクのキャンセル

**ユーザーストーリー:** ユーザーとして、処理中のタスクをキャンセルしたい。これにより、不要になったダウンロードを停止し、システムリソースを節約できる。

#### 受け入れ基準

1. 処理中またはキュー中のタスクの横に「キャンセル」ボタンが表示されること
2. ユーザーがキャンセルボタンをクリックした時、システムはRedis内のタスクステータスを「キャンセル済み」に更新すること
3. バックグラウンドワーカーがキャンセル済みタスクを検知した時、処理を停止し、部分的な結果を削除すること
4. キャンセルされたタスクは、UIで「キャンセル済み」ステータスとして表示されること
5. 完了済みまたは失敗済みのタスクはキャンセルできず、キャンセルボタンが表示されないこと

## 非機能要件

### パフォーマンス
- タスク作成のAPI応答時間：< 500ms
- 進捗取得のAPI応答時間：< 2秒
- フロントエンドのポーリング間隔：1.5秒
- Redis接続：自動再接続付きの永続接続プール
- タスク処理：シミュレートされたダウンロードは段階的な進捗を実証すること（0% → 100%、2%刻み）

### セキュリティ
- 認証：簡易APIキー認証（X-API-Keyヘッダー）
  - 開発用に固定APIキー使用（user1: "dev-key-user1", user2: "dev-key-user2"）
  - APIキーからuser_idをマッピング
  - 本番環境ではJWT等への移行を推奨
- APIエンドポイント：localhost開発用のCORS設定（本番環境では特定のオリジンのみ許可）
- タスクID：列挙攻撃を防ぐためのUUID v4形式
- レート制限：ユーザーあたり1分間に最大10タスク作成（APIキー単位）
- ファイルアクセス：認証必須、ユーザー自身のタスクのみアクセス可能
- Redis：セキュアな接続文字列経由の接続（SSL付きAzure Redis）
- 入力検証：タスクID形式の検証（UUID v4パターンマッチング）

### 信頼性
- Redis接続：指数バックオフ（1秒、2秒、4秒）付きの自動リトライメカニズム（最大3回）
- タスク状態の永続化：Redisに最低24時間保持（設定可能なTTL）
- エラーハンドリング：特定のエラーメッセージを含む包括的なtry-catch
- 失敗タスクの回復：エラー詳細（タイプ、メッセージ、スタックトレース、タイムスタンプ）をRedisに保存
- タスクタイムアウト：30分で自動タイムアウトし、ステータスを「タイムアウト」に更新

### ユーザビリティ
- UI：タスクステータスの明確な視覚的インジケーター（色分け：キュー中=青、処理中=黄、完了=緑、失敗=赤、キャンセル済み=グレー）
- 進捗表示：パーセンテージ（例：45%）と視覚的なプログレスバー
- タスクリスト：作成時刻の降順でソート、ステータスでフィルタリング可能
- レスポンシブデザイン：Tailwind CSSを使用したモバイルフレンドリーなインターフェース
- アクセシビリティ：ARIA ラベル、キーボードナビゲーション対応

### スケーラビリティ
- Redis：100以上の同時タスクをサポート（Azureティアに基づいて設定可能）
- タスク処理：バックグラウンドワーカーパターン（FastAPIバックグラウンドタスク）
- ストレージ：完了タスクのファイルクリーンアップメカニズム（24時間後に自動削除）
- 接続プール：Redis接続プール（最大接続数：50）

### 開発要件
- コード構造：Next.js App Router パターン（app/downloads/page.tsx）
- 環境変数：`.env.local`ファイルで設定（REDIS_URL、NEXT_PUBLIC_API_URL、API_KEY）
- ドキュメント：インラインコメント（日本語）とセットアップ手順を含むREADME
- エラーログ：構造化ログ（開発：コンソール、本番：ファイル/クラウドロギング）
- TypeScript：フロントエンドは完全な型定義、Python型ヒント（FastAPI）
- 認証：簡易APIキー認証（X-API-Key ヘッダー）でユーザー識別
