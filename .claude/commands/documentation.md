---
description: 設計書（design.md）を docs/ へ昇格し、永続ドキュメントとして保存します。
---
# Documentation Command (/documentation)

`/documentation` は、`docs/specs/{feature-name}/design.md` の内容を `docs/` 配下の永続ドキュメントへ昇格（転記）するコマンドです。

## Usage

```bash
/documentation <feature-name>
```

## 概要

開発中に作成した統合設計書（design.md）は、実装完了後に永続ドキュメントへ昇格する必要があります。このコマンドは、design.md の各セクションを対応する `docs/` ファイルへ自動的に転記します。

### 昇格の目的

- **一時的なSpec** → **永続的なドキュメント** への変換
- 既存ドキュメントとの整合性維持
- プロジェクト全体のドキュメント品質向上

---

## 実行プロセス

### Step 1. 設計書の読み込み

```text
📋 設計書読み込み中...

Spec: docs/specs/{feature-name}/design.md
Status: Implementation
Last Updated: 2025-11-27
```

### Step 2. 昇格チェックリスト検証

design.md の「Section 12. 昇格チェックリスト」を検証します:

```text
📋 昇格チェックリスト検証 ({feature-name})

必須項目:
  ✅ 機能要件 → docs/functional_requirements.md
     - 機能ID: F-028 (自動採番)
     - 機能名: {機能名}

  ✅ API仕様 → docs/api/{feature}_apis.md
     - エンドポイント: 2件
     - フォーマット: OK

  ✅ API一覧更新 → docs/api/README.md
     - 総数: 29 → 31

条件付き項目:
  ✅ サービス層 → docs/design/service_layer_design.md
     - 新規Service: {ServiceName}

  ✅ データベース → docs/database/schema/{table}.md
     - 新規テーブル: {table_name}

  ⬜ フロントエンド → (該当なし)

  ⬜ シーケンス図 → (該当なし)

検証項目:
  ✅ 全テストがパス
  ✅ コードレビュー完了

セキュリティチェック (参照: docs/security/README.md):
  ✅ XSS対策: サニタイジング実装済み
  ✅ SQLインジェクション対策: バリデーション実装済み
  ✅ 認証・認可: ロールベースアクセス制御実装済み
  ✅ Cache-Control: 認証必須エンドポイントにno-store設定済み
  ⬜ Blob Storage: (該当なし)
  ✅ 入力バリデーション: 全フィールドに制約実装済み

Gitステータス確認:
  ✅ 作業ツリーはクリーン（Uncommitted changesなし）
  ✅ リモートと同期済み（git pull済み）

続行しますか? [Y/n]: _
```

### Step 3. 昇格実行

ユーザー承認後、以下の処理を自動実行します。

---

## 昇格先マッピング

| design.md セクション           | 昇格先                                             | 条件                   |
| ------------------------------ | -------------------------------------------------- | ---------------------- |
| Section 1 (概要)               | `docs/functional_requirements.md`                | 常に                   |
| Section 2 (API設計)            | `docs/api/{feature}_apis.md`                     | 新規API有り            |
| Section 3 (データモデル)       | `docs/api/{feature}_apis.md`                     | Section 2 と統合       |
| Section 4 (サービス層)         | `docs/design/service_layer_design.md`            | 新規Service有り        |
| Section 5 (データベース)       | `docs/database/schema/{table}.md`                | 新規テーブル有り       |
| Section 6 (状態遷移)           | `docs/design/service_layer_design.md`            | 状態管理有り           |
| Section 7 (フロントエンド)     | `docs/design/detailed_design/frontend/`          | 新規コンポーネント有り |
| Section 8 (エラーハンドリング) | `docs/design/service_layer_design.md`            | 新規例外有り           |
| Section 9 (テスト)             | `docs/testing/{category}/`                       | テストケース有り       |
| Section 10 (シーケンス図)      | `docs/design/detailed_design/sequence_diagrams/` | 図表有り               |
| Section 11 (実装メモ)          | (昇格なし)                                         | -                      |
| Section 12 (チェックリスト)    | (昇格制御用)                                       | -                      |

---

## 昇格処理の詳細

### A. 機能要件追加 (`docs/functional_requirements.md`)

**冪等性チェック**:

1. `docs/functional_requirements.md` を読み込む
2. **チェック**: 機能ID（例: `F-028`）が既に存在するか確認
3. **存在する場合**: 既存エントリを更新、または「スキップして警告」
4. **存在しない場合**: 新規行を追記

design.md Section 1 の内容を機能一覧テーブルに追記:

```markdown
<!-- 自動追記 -->
| F-028 | {機能名} | {機能概要} | POST /api/v1/{resource} | frontend/src/app/{feature} | ✅ 実装済み | {備考} |
```

### B. API仕様書作成 (`docs/api/{feature}_apis.md`)

- design.md Section 2, 3 の内容を抽出
- 既存API仕様書フォーマットに自動整形
- ヘッダー・フッター追加
- Pydantic Model → JSON Schema形式も併記

### C. API一覧更新 (`docs/api/README.md`)

- エンドポイント総数更新
- 新規APIへのリンク追加

### D. サービス層追記 (`docs/design/service_layer_design.md`)

- design.md Section 4, 6, 8 の内容を適切なセクションに追記
- 目次更新
- クラス設計をdocstring付きで整形

### E. データベーススキーマ作成 (`docs/database/schema/{table}.md`)

- design.md Section 5 の内容を抽出
- 既存スキーマ文書フォーマットに整形

### F. フロントエンド設計追記 (`docs/design/detailed_design/frontend/`)

- design.md Section 7 の内容を追記
- コンポーネント設計書フォーマットに整形

### G. テストケース転記 (`docs/testing/`)

- design.md Section 9 の内容を適切なカテゴリに転記
- テスト計画書フォーマットに整形

### H. シーケンス図作成 (`docs/design/detailed_design/sequence_diagrams/`)

- design.md Section 10 の内容を新規ファイルとして作成
- Mermaid形式を維持

### I. 相互参照追加

各昇格先ドキュメントに実装履歴を追記:

```markdown
**実装履歴**: Spec `docs/specs/{feature-name}/` (2025-11-27)
```

### J. Spec ステータス更新

design.md のステータスを更新:

```markdown
| **Status** | ~~Implementation~~ → Merged |
```

### K. アーカイブマーカー追加 & ファイル移動

昇格完了後:

**Step 1**: design.md の先頭に以下を追記してアーカイブ化:

```markdown
> **Note**: This spec has been merged into docs/ on YYYY-MM-DD. Do not edit this file directly.
> 昇格先: docs/functional_requirements.md, docs/api/{feature}_apis.md, etc.
```

**Step 2**: Specフォルダを `docs/specs/archive/` へ移動:

```bash
mv docs/specs/{feature-name}/ docs/specs/archive/{feature-name}/
```

これにより、誤って古いSpecを編集することを防止し、アクティブなSpecと昇格済みSpecを分離します。

### L. アセットファイルの移動（該当する場合）

design.md 内で画像を参照している場合:

1. `docs/specs/{feature-name}/images/` 内の画像ファイルを検出
2. `docs/images/{feature-name}/` へ移動またはコピー
3. 昇格させるMarkdown内の画像リンクパスを自動置換

```text
変換例:
  Before: ![構成図](./images/arch.png)
  After:  ![構成図](../../images/{feature-name}/arch.png)
```

**注意**: 画像ファイルがない場合はこのステップはスキップされます。

---

## 昇格結果表示

```text
📋 ドキュメント昇格完了 ({feature-name})

昇格されたドキュメント:
  ✅ docs/functional_requirements.md (F-028追加)
  ✅ docs/api/{feature}_apis.md (新規作成)
  ✅ docs/api/README.md (エンドポイント数更新: 29→31)
  ✅ docs/design/service_layer_design.md ({ServiceName}追加)
  ✅ docs/database/schema/{table}.md (新規作成)

Spec Status更新:
  docs/specs/{feature-name}/design.md → docs/specs/archive/{feature-name}/design.md
    Status: Implementation → Merged

次のステップ:
  1. 昇格されたドキュメントを確認してください
  2. 問題なければコミット・PRを作成
```

---

## フォーマット変換ルール

### API仕様書変換

- design.md の簡易形式 → `docs/api/` の詳細形式
- Pydantic Model → JSON Schema形式も併記
- セキュリティ情報を表形式に変換

### サービス層変換

- クラス設計をdocstring付きで整形
- 依存関係図を追加
- 既存パターンへの参照リンク維持

### テストケース変換

- 表形式をテスト計画書形式に変換
- テストファイルパスを明記

---

## Spec ステータス管理

| Status         | 説明       | 次のステータス   |
| -------------- | ---------- | ---------------- |
| Draft          | 設計中     | Review           |
| Review         | レビュー中 | Implementation   |
| Implementation | 実装中     | Merged           |
| Merged         | 昇格完了   | (アーカイブ対象) |

### アーカイブポリシー

`Status: Merged` のSpecは以下のタイミングでアーカイブ:

- 昇格完了から3ヶ月経過
- または手動で `/spec-archive {feature-name}` 実行

アーカイブ先: `docs/specs/archive/{feature-name}/`

---

## 使用例

```bash
# 基本実行
/documentation staff-csv-export

# 複数Spec一括昇格
/documentation staff-csv-export user-profile-edit

# ドライラン（実際には書き込まない）
/documentation staff-csv-export --dry-run
```

---

## トラブルシューティング

### エラー: 昇格チェックリストが未完了

```text
❌ 昇格チェックリスト検証失敗
   - API仕様: Section 2が空です
   - テスト: 全テストがパスしていません

解決方法:
  1. design.md Section 2 を記入してください
  2. pytest を実行してテストをパスさせてください
```

### エラー: フォーマット変換失敗

```text
❌ フォーマット変換失敗
   - docs/api/{feature}_apis.md: Pydantic Modelの解析に失敗

解決方法:
  1. design.md Section 2.2 のPydantic Modelを確認してください
  2. 構文エラーがないか確認してください
```

### エラー: 昇格先ファイルが存在しない

```text
❌ 昇格先ファイル未検出
   - docs/design/service_layer_design.md が存在しません

解決方法:
  1. ファイルを手動で作成してください
  2. または既存のファイルパスを確認してください
```

### 昇格を取り消す場合

```bash
# 直前の昇格を取り消し
git checkout HEAD~1 -- docs/

# 特定ファイルのみ取り消し
git checkout HEAD~1 -- docs/api/{feature}_apis.md
```

---

## 関連コマンド

- `/spec {feature-name}`: 統合設計書を作成
- `/wrap-up`: 品質チェック・リリース準備（/documentationを案内）
- `/check-impact`: コード変更の影響範囲分析
