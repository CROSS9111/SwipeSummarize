# LLM 統合機能テストケース

## 概要

Vercel AI SDK 統合機能（F-001-VERCEL-AI-SDK）のテストケース仕様書。

## テスト環境

- Node.js 18+
- Next.js 16.1
- Supabase（ローカル/ステージング/本番）
- 各 LLM プロバイダーのテストアカウント

## テストカテゴリ

1. **単体テスト**: 個別機能の動作確認
2. **統合テスト**: システム間連携の確認
3. **E2E テスト**: ユーザーシナリオの確認
4. **性能テスト**: レスポンス時間とスループット
5. **セキュリティテスト**: API キー管理と暗号化

---

## 1. 単体テスト

### UT-001: LLM クライアント初期化

**目的**: 各プロバイダーのクライアントが正しく初期化されることを確認

```typescript
describe('LLMClient', () => {
  test('Azure OpenAI クライアントの初期化', () => {
    const config = {
      provider: 'azure-openai',
      model: 'gpt-4',
      endpoint: 'https://test.openai.azure.com',
      apiKey: 'test-key',
      deploymentName: 'test-deployment',
      apiVersion: '2024-02-15-preview'
    };

    const client = new LLMClient(config);
    expect(client).toBeDefined();
    expect(client.config.provider).toBe('azure-openai');
  });
});
```

### UT-002: プロンプト構築

**目的**: 要約プロンプトが正しく構築されることを確認

**テストデータ**:
- 短い記事（100 文字）
- 長い記事（10000 文字超）
- 特殊文字を含む記事

**期待結果**:
- プロンプトが適切にフォーマットされる
- 10000 文字で切り詰められる

### UT-003: コスト計算

**目的**: トークン使用量からコストが正確に計算されることを確認

**テストケース**:
| プロバイダー | モデル     | 入力トークン | 出力トークン | 期待コスト |
| ------------ | ---------- | ------------ | ------------ | ---------- |
| openai       | gpt-4o     | 1000         | 500          | $0.0125    |
| azure-openai | gpt-4      | 2000         | 1000         | $0.12      |
| google       | gemini-1.5-flash | 5000   | 2000         | $0.001     |

---

## 2. 統合テスト

### IT-001: データベース連携

**目的**: LLM 設定の保存と取得が正しく動作することを確認

**手順**:
1. 新しい LLM 設定を POST /api/llm/settings で保存
2. GET /api/llm/settings で取得
3. 暗号化された API キーが正しく復号される

**期待結果**:
- 設定が正しく保存される
- API キーが暗号化されて保存される
- 取得時に正しく復号される

### IT-002: 使用履歴記録

**目的**: LLM 使用履歴が正確に記録されることを確認

**手順**:
1. 要約を生成
2. llm_usage テーブルを確認
3. saved テーブルの LLM 関連カラムを確認

**期待結果**:
- トークン数、コスト、実行時間が記録される
- saved テーブルにプロバイダー情報が記録される

### IT-003: フォールバック機能

**目的**: プロバイダーエラー時に自動的に切り替わることを確認

**手順**:
1. プライマリプロバイダーを無効な API キーで設定
2. セカンダリプロバイダーを有効な API キーで設定
3. 要約生成を実行

**期待結果**:
- プライマリでエラー発生
- 自動的にセカンダリで処理
- 両方の試行が llm_usage に記録される

---

## 3. E2E テスト

### E2E-001: 設定から要約生成までの完全フロー

**シナリオ**: 新規ユーザーが LLM 設定を行い、記事要約を生成する

**手順**:
1. /settings/llm にアクセス
2. Azure OpenAI を選択
3. 設定情報を入力
4. 接続テストを実行
5. 設定を保存
6. ホーム画面に戻る
7. 記事 URL を入力
8. 要約を生成
9. 結果を確認

**期待結果**:
- 各ステップでエラーが発生しない
- 要約が 3-5 文で生成される
- コスト情報が表示される

### E2E-002: プロバイダー切り替え

**シナリオ**: 使用中にプロバイダーを切り替える

**手順**:
1. Gemini で要約を生成
2. /settings/llm で Azure OpenAI に切り替え
3. 同じ記事で再度要約を生成
4. 結果を比較

**期待結果**:
- 切り替えが即座に反映される
- 異なるプロバイダーで異なる要約が生成される
- 両方の使用履歴が記録される

---

## 4. エラーケーステスト

### ERR-001: 無効な API キー

**条件**: 無効な API キーで要約生成

**期待結果**:
- エラーコード: API_KEY_INVALID
- ユーザーフレンドリーなエラーメッセージ
- 設定画面への誘導リンク

### ERR-002: レート制限

**条件**: レート制限に到達

**期待結果**:
- エラーコード: RATE_LIMITED
- 自動的に別プロバイダーへフォールバック
- フォールバック失敗時はエラーメッセージ

### ERR-003: タイムアウト

**条件**: リクエストが 30 秒でタイムアウト

**期待結果**:
- エラーコード: TIMEOUT
- 最大 3 回リトライ
- 全て失敗時はエラーメッセージ

### ERR-004: 長文処理

**条件**: 50000 文字の記事を処理

**期待結果**:
- 10000 文字で切り詰め
- 警告メッセージ表示
- 要約は正常に生成

---

## 5. 性能テスト

### PERF-001: レスポンス時間

**基準値**:
| プロバイダー | 平均応答時間 | 最大応答時間 |
| ------------ | ------------ | ------------ |
| Azure OpenAI | < 2秒        | < 5秒        |
| OpenAI       | < 1.5秒      | < 4秒        |
| Gemini       | < 1秒        | < 3秒        |
| Ollama (ローカル) | < 3秒  | < 10秒       |

### PERF-002: 同時リクエスト

**条件**: 10 件の同時リクエスト

**期待結果**:
- 全リクエストが正常に処理される
- レート制限にかからない
- 平均応答時間が基準値以内

### PERF-003: メモリ使用量

**条件**: 100 件の連続処理

**期待結果**:
- メモリリークが発生しない
- メモリ使用量が 500MB 以内

---

## 6. セキュリティテスト

### SEC-001: API キー暗号化

**目的**: API キーが平文で保存されないことを確認

**手順**:
1. API キーを設定
2. データベースを直接確認

**期待結果**:
- config カラムの apiKey が暗号化されている
- 復号関数でのみ平文取得可能

### SEC-002: クライアントサイド露出

**目的**: API キーがクライアントに露出しないことを確認

**手順**:
1. ブラウザの開発者ツールでネットワークを監視
2. API コールを実行

**期待結果**:
- レスポンスに API キーが含まれない
- クライアントサイドのコードに API キーがない

### SEC-003: SQL インジェクション

**目的**: SQL インジェクション脆弱性がないことを確認

**テストデータ**:
```sql
'; DROP TABLE llm_settings; --
' OR '1'='1
```

**期待結果**:
- エラーが発生するが、テーブルは削除されない
- パラメータ化クエリが使用される

---

## 7. 境界値テスト

### BOUND-001: 最大トークン数

**テストケース**:
| maxTokens | 期待動作              |
| --------- | --------------------- |
| 0         | エラー                |
| 1         | 1 トークンの要約      |
| 8000      | 8000 トークンまで生成 |
| 8001      | エラー                |

### BOUND-002: Temperature パラメータ

**テストケース**:
| temperature | 期待動作           |
| ----------- | ------------------ |
| -0.1        | エラー             |
| 0.0         | 確定的な出力       |
| 0.7         | バランスの取れた出力 |
| 1.0         | 創造的な出力       |
| 1.1         | エラー             |

---

## 8. 回帰テスト

### REG-001: 既存機能への影響確認

**確認項目**:
- [ ] 既存の Gemini API が引き続き動作する（後方互換性）
- [ ] URL 保存機能が正常に動作する
- [ ] スワイプ UI が正常に動作する
- [ ] 保存済み記事の表示が正常

---

## 9. テスト自動化

### 自動化対象

```yaml
# .github/workflows/llm-tests.yml
name: LLM Integration Tests

on:
  push:
    paths:
      - 'lib/llm/**'
      - 'app/api/llm/**'
      - 'app/api/summarize/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run unit tests
        run: npm run test:llm:unit
      - name: Run integration tests
        run: npm run test:llm:integration
        env:
          AZURE_TEST_KEY: ${{ secrets.AZURE_TEST_KEY }}
          OPENAI_TEST_KEY: ${{ secrets.OPENAI_TEST_KEY }}
```

---

## 10. テストデータ

### サンプル記事 URL

```javascript
const TEST_URLS = [
  'https://example.com/short-article',     // 短い記事
  'https://example.com/long-article',      // 長い記事
  'https://example.com/japanese-article',  // 日本語記事
  'https://example.com/technical-article', // 技術記事
  'https://example.com/news-article'       // ニュース記事
];
```

### モックレスポンス

```javascript
const MOCK_SUMMARY = {
  summary: "この記事は人工知能の最新動向について説明しています。特に大規模言語モデルの進化について詳しく解説されています。今後の展望も示されています。",
  metadata: {
    provider: "azure-openai",
    model: "gpt-4",
    tokensUsed: { input: 2500, output: 150, total: 2650 },
    estimatedCost: 0.08,
    processingTime: 1234
  }
};
```

---

## チェックリスト

### リリース前チェック

- [ ] 全単体テストがパス
- [ ] 全統合テストがパス
- [ ] E2E テストがパス
- [ ] 性能基準を満たす
- [ ] セキュリティテストがパス
- [ ] ドキュメント更新完了
- [ ] 環境変数設定確認
- [ ] データベースマイグレーション完了